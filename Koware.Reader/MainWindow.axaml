<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:Koware.Reader"
        x:Class="Koware.Reader.MainWindow"
        x:DataType="local:MainWindow"
        Title="Koware Reader"
        Width="1000" Height="800"
        MinWidth="600" MinHeight="500"
        WindowStartupLocation="CenterScreen"
        Background="#1a1a2e"
        KeyDown="OnKeyDown">
    
    <Window.Styles>
        <!-- Toolbar buttons -->
        <Style Selector="Button.toolbar">
            <Setter Property="Background" Value="#2b2b4c" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="#3c446a" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="MinHeight" Value="36" />
            <Setter Property="MinWidth" Value="36" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5" />
        </Style>
        <Style Selector="Button.toolbar:pointerover">
            <Setter Property="Background" Value="#343a62" />
            <Setter Property="BorderBrush" Value="#55639a" />
        </Style>
        <Style Selector="Button.toolbar:pressed">
            <Setter Property="Background" Value="#2a2f54" />
            <Setter Property="BorderBrush" Value="#6c7ac0" />
            <Setter Property="RenderTransform">
                <ScaleTransform ScaleX="0.98" ScaleY="0.98" />
            </Setter>
        </Style>
        <Style Selector="Button.toolbar:focus-visible">
            <Setter Property="BorderBrush" Value="#7ec4ff" />
        </Style>
        
        <!-- Page slider -->
        <Style Selector="Slider#PageSlider">
            <Setter Property="Height" Value="36" />
        </Style>
        <Style Selector="Slider#PageSlider /template/ Thumb">
            <Setter Property="Width" Value="34" />
            <Setter Property="Height" Value="14" />
            <Setter Property="Background" Value="#6d7ea6" />
            <Setter Property="BorderBrush" Value="#9acbff" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="7" />
        </Style>
        <Style Selector="Slider#PageSlider /template/ Thumb:pointerover">
            <Setter Property="Background" Value="#7ec4ff" />
            <Setter Property="BorderBrush" Value="#d6e9ff" />
        </Style>
        
        <!-- Overlays -->
        <Style Selector="Border.overlay">
            <Setter Property="Opacity" Value="1" />
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.18" />
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Border.overlay:not(:visible)">
            <Setter Property="Opacity" Value="0" />
        </Style>
        
        <!-- Shortcut rows -->
        <Style Selector="Border.shortcut-row">
            <Setter Property="Background" Value="#12122b" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="Margin" Value="0,0,0,4" />
        </Style>
        <Style Selector="Border.shortcut-row.alt">
            <Setter Property="Background" Value="#141437" />
        </Style>
    </Window.Styles>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" 
                Background="#0d0d1a"
                Padding="12,8"
                x:Name="HeaderBar">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <TextBlock x:Name="TitleText"
                           Grid.Column="0"
                           Text="Koware Reader"
                           FontSize="17"
                           FontWeight="Bold"
                           Foreground="White"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis" />
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <StackPanel Orientation="Vertical" Margin="0,0,16,0">
                        <TextBlock x:Name="ChapterLabel"
                                   Text="Chapter"
                                   Foreground="#a3abc4"
                                   FontSize="12"
                                   TextTrimming="CharacterEllipsis" />
                        <TextBlock x:Name="PageIndicator"
                                   Text="Page 1 / 1"
                                   Foreground="#a3abc4"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center" />
                    </StackPanel>
                    
                    <Button Classes="toolbar"
                            Content="Chapters"
                            Click="OnChaptersClick"
                            ToolTip.Tip="Open chapter list" />

                    <Button Classes="toolbar"
                            Content="Prev Chapter"
                            Click="OnPrevChapterClick"
                            ToolTip.Tip="Previous chapter" />
                    <Button Classes="toolbar"
                            Content="Next Chapter"
                            Click="OnNextChapterClick"
                            ToolTip.Tip="Next chapter" />
                    
                    <!-- Zoom Controls -->
                    <Button Classes="toolbar"
                            Click="OnZoomOutClick"
                            ToolTip.Tip="Zoom out (−)"
                            Padding="0">
                        <Viewbox Width="16" Height="16" Stretch="Uniform">
                            <Path Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                  StrokeThickness="2.4"
                                  StrokeLineCap="Round"
                                  Data="M5 12h14" />
                        </Viewbox>
                    </Button>
                    <TextBlock x:Name="ZoomIndicator"
                               Text="100%"
                               Foreground="#a3abc4"
                               VerticalAlignment="Center"
                               Width="45"
                                TextAlignment="Center" />
                    <Button Classes="toolbar"
                            Click="OnZoomInClick"
                            ToolTip.Tip="Zoom in (+)"
                            Padding="0">
                        <Viewbox Width="16" Height="16" Stretch="Uniform">
                            <Canvas Width="24" Height="24">
                                <Path Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                      StrokeThickness="2.4"
                                      StrokeLineCap="Round"
                                      Data="M5 12h14" />
                                <Path Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                      StrokeThickness="2.4"
                                      StrokeLineCap="Round"
                                      Data="M12 5v14" />
                            </Canvas>
                        </Viewbox>
                    </Button>
                    
                    <Button x:Name="FitModeButton" Classes="toolbar"
                            Content="Fit Width"
                            Click="OnFitModeClick"
                            ToolTip.Tip="Cycle fit mode (W)" />
                    
                    <Button x:Name="DoublePageButton" Classes="toolbar"
                            Content="Single"
                            Click="OnDoublePageClick"
                            ToolTip.Tip="Toggle double-page view (D)" />
                    
                    <Button x:Name="FullscreenButton" Classes="toolbar"
                            Click="OnFullscreenClick"
                            Foreground="White"
                            Padding="0"
                            ToolTip.Tip="Fullscreen (F)">
                        <Viewbox Width="16" Height="16" Stretch="Uniform">
                            <Path Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                  StrokeThickness="2"
                                  StrokeLineCap="Round"
                                  Data="M5 9V5h4M5 15v4h4M19 9V5h-4M19 15v4h-4" />
                        </Viewbox>
                    </Button>
                    
                    <Button Classes="toolbar"
                            Content="?"
                            Click="OnHelpCloseClick"
                            Foreground="#aaa"
                            Padding="0"
                            ToolTip.Tip="Keyboard shortcuts (H)">
                        <Viewbox Width="16" Height="16" Stretch="Uniform">
                            <Canvas Width="24" Height="24">
                                <Path Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                      StrokeThickness="2"
                                      StrokeLineCap="Round"
                                      Data="M8 8a4 4 0 1 1 8 0c0 1.38-.86 2.59-2.06 3.26-.43.25-.87.51-1.25.84-.4.36-.64.88-.64 1.42v1.48" />
                                <Ellipse Width="2" Height="2"
                                         Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                         Canvas.Left="11" Canvas.Top="18" />
                            </Canvas>
                        </Viewbox>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main Content -->
        <Border Grid.Row="1" Background="{DynamicResource ReaderBackground}" x:Name="ContentWrapper">
        <ScrollViewer x:Name="ScrollViewer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      Background="{DynamicResource ReaderBackground}">
            <StackPanel x:Name="PagesContainer"
                        HorizontalAlignment="Center"
                        Margin="0,8">
                <!-- Pages will be added dynamically -->
            </StackPanel>
        </ScrollViewer>
        <Rectangle x:Name="ComfortOverlay"
                   Grid.Row="1"
                   Fill="#000000"
                   Opacity="0"
                   IsHitTestVisible="False" />
        </Border>
        
        <!-- Loading Overlay -->
        <Border x:Name="LoadingOverlay"
                Grid.Row="1"
                Background="#cc1a1a2e"
                IsVisible="True">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Width="300">
                <TextBlock Text="Loading pages..."
                           Foreground="White"
                           FontSize="20"
                           HorizontalAlignment="Center" />
                <ProgressBar x:Name="LoadingProgressBar"
                             Minimum="0" Maximum="100" Value="0"
                             Height="8"
                             Margin="0,16,0,8"
                             Background="#333"
                             Foreground="#60a5fa" />
                <TextBlock x:Name="LoadingProgress"
                           Text="0 / 0"
                           Foreground="#888"
                           FontSize="14"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>
        
        <!-- Footer Navigation -->
        <Border Grid.Row="2"
                Background="#0d0d1a"
                Padding="12,10"
                x:Name="FooterBar">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <Button Content="← Prev"
                            Click="OnPreviousClick"
                            Background="#2a2a4a"
                            Foreground="White"
                            Padding="12,8"
                            MinHeight="36"
                            ToolTip.Tip="Previous page (←)" />
                    <Button Content="Next →"
                            Click="OnNextClick"
                            Background="#2a2a4a"
                            Foreground="White"
                            Padding="12,8"
                            MinHeight="36"
                            ToolTip.Tip="Next page (→)" />
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center">
                    <Slider x:Name="PageSlider"
                            Minimum="1" Maximum="1" Value="1"
                            Margin="0,0,0,4"
                            VerticalAlignment="Center"
                            ToolTip.Tip="Scrub pages (drag or use ← / →)"
                            ValueChanged="OnPageSliderChanged" />
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="ProgressLabel"
                                   Grid.Column="0"
                                   Text="0%"
                                   Foreground="#a3abc4"
                                   Margin="0,0,8,0"/>
                        <TextBlock x:Name="ChapterNameLabel"
                                   Grid.Column="1"
                                   Text="Chapter"
                                   Foreground="#dfe6ff"
                                   TextAlignment="Center"
                                   TextTrimming="CharacterEllipsis"/>
                        <Ellipse x:Name="PrefetchDot"
                                 Grid.Column="2"
                                 Width="10" Height="10"
                                 Fill="#60a5fa"
                                 VerticalAlignment="Center"
                                 Visibility="Collapsed"
                                 ToolTip.Tip="Prefetching pages..." />
                    </Grid>
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <ComboBox x:Name="ThemeSelector"
                              Width="120"
                              SelectionChanged="OnThemeChanged">
                        <ComboBoxItem Content="Dark" />
                        <ComboBoxItem Content="Sepia" />
                        <ComboBoxItem Content="Light" />
                    </ComboBox>
                    <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                        <TextBlock Text="Comfort" Foreground="#a3abc4" VerticalAlignment="Center"/>
                        <Slider x:Name="ComfortSlider"
                                Width="120"
                                Minimum="0"
                                Maximum="0.6"
                                SmallChange="0.05"
                                ValueChanged="OnComfortChanged"/>
                    </StackPanel>
                    <ToggleSwitch x:Name="AutoHideToggle"
                                  Content="Hide UI on idle"
                                  Checked="OnAutoHideToggled"
                                  Unchecked="OnAutoHideToggled"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Help Overlay -->
        <Border x:Name="HelpOverlay"
                Classes="overlay"
                Grid.RowSpan="3"
                Background="#f00d0d1a"
                IsVisible="False">
            <Border Background="#202442"
                    CornerRadius="14"
                    Padding="36"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    MinWidth="400"
                    MaxWidth="640">
                <StackPanel Spacing="16">
                    <TextBlock Text="Keyboard Shortcuts"
                               Foreground="White"
                               FontSize="20"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center" />
                    
                    <StackPanel Spacing="10">
                        <TextBlock Text="Navigation" Foreground="#888" FontWeight="SemiBold" />
                        <Border Classes="shortcut-row">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="← / →" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Previous / Next page" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row alt">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Home / End" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="First / Last page" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="1-9" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Jump to position in chapter" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        
                        <TextBlock Text="View" Foreground="#888" FontWeight="SemiBold" Margin="0,8,0,0" />
                        <Border Classes="shortcut-row alt">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="+ / −" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Zoom in / out" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Ctrl+Scroll" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Mouse wheel zoom" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row alt">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="0" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Reset zoom to 100%" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="W" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Cycle fit mode" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row alt">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="D" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Toggle double-page view" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="F / F11" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Toggle fullscreen" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        
                        <TextBlock Text="General" Foreground="#888" FontWeight="SemiBold" Margin="0,8,0,0" />
                        <Border Classes="shortcut-row alt">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="H / ?" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Show/hide this help" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                        <Border Classes="shortcut-row">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Esc / Q" Foreground="#60a5fa" FontFamily="Consolas" Width="120" />
                                <TextBlock Text="Close reader" Foreground="#ccc" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                    
                    <Button Click="OnHelpCloseClick"
                            Background="#3a3a5a"
                            Foreground="White"
                            Padding="20,10"
                            Margin="0,8,0,0"
                            CornerRadius="10"
                            HorizontalAlignment="Center"
                            ToolTip.Tip="Close shortcuts overlay">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Viewbox Width="16" Height="16" Stretch="Uniform">
                                <Path Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                      StrokeThickness="2"
                                      StrokeLineCap="Round"
                                      Data="M5 12l4 4 10-10" />
                            </Viewbox>
                            <TextBlock Text="Got it" FontWeight="SemiBold" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </Border>
        
        <!-- Error Overlay -->
        <Border x:Name="ErrorOverlay"
                Classes="overlay"
                Grid.RowSpan="3"
                Background="#f01a1a2e"
                IsVisible="False">
            <Border Background="#23263f"
                    CornerRadius="14"
                    Padding="28"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center">
                <StackPanel VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Spacing="12">
                    <TextBlock Text="⚠"
                               Foreground="#f87171"
                               FontSize="48"
                               HorizontalAlignment="Center" />
                    <TextBlock x:Name="ErrorText"
                               Text="Failed to load pages"
                               Foreground="#f87171"
                               FontSize="18"
                               HorizontalAlignment="Center"
                               TextWrapping="Wrap"
                               MaxWidth="400" />
                    <Button Content="Close"
                            Click="OnCloseClick"
                            Padding="18,10"
                            CornerRadius="10"
                            Margin="0,8,0,0"
                            HorizontalAlignment="Center"
                            ToolTip.Tip="Close reader" />
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</Window>
